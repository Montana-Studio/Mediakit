'use strict';

<<<<<<< HEAD
var bufferToVinyl = require('buffer-to-vinyl');
var concatStream = require('concat-stream');
var optional = require('optional');
var streamCombiner = require('stream-combiner2');
var through = require('through2');
var vinylFs = require('vinyl-fs');
=======
var combine = require('stream-combiner');
var concat = require('concat-stream');
var EventEmitter = require('events').EventEmitter;
var File = require('vinyl');
var fs = require('vinyl-fs');
var inherits = require('util').inherits;
var optional = require('optional');
var through = require('through2');
>>>>>>> f8417fafd5bf20d329bf2e3402fca16fd839cf1f

/**
 * Initialize Imagemin
 *
 * @api public
 */

function Imagemin() {
	if (!(this instanceof Imagemin)) {
		return new Imagemin();
	}

<<<<<<< HEAD
=======
	EventEmitter.call(this);
>>>>>>> f8417fafd5bf20d329bf2e3402fca16fd839cf1f
	this.streams = [];
}

/**
<<<<<<< HEAD
=======
 * Inherit from `EventEmitter`
 */

inherits(Imagemin, EventEmitter);

/**
>>>>>>> f8417fafd5bf20d329bf2e3402fca16fd839cf1f
 * Get or set the source files
 *
 * @param {Array|Buffer|String} file
 * @api public
 */

Imagemin.prototype.src = function (file) {
	if (!arguments.length) {
		return this._src;
	}

	this._src = file;
	return this;
};

/**
 * Get or set the destination folder
 *
 * @param {String} dir
 * @api public
 */

Imagemin.prototype.dest = function (dir) {
	if (!arguments.length) {
		return this._dest;
	}

	this._dest = dir;
	return this;
};

/**
 * Add a plugin to the middleware stack
 *
 * @param {Function} plugin
 * @api public
 */

Imagemin.prototype.use = function (plugin) {
	this.streams.push(typeof plugin === 'function' ? plugin() : plugin);
	return this;
};

/**
 * Optimize files
 *
 * @param {Function} cb
 * @api public
 */

Imagemin.prototype.run = function (cb) {
<<<<<<< HEAD
	cb = cb || function () {};

	var stream = this.createStream();

	stream.on('error', cb);
	stream.pipe(concatStream(cb.bind(null, null)));
};

/**
 * Create stream
 *
 * @api private
 */

Imagemin.prototype.createStream = function () {
	this.streams.unshift(this.getFiles());

	if (this.streams.length === 1) {
		this.use(Imagemin.gifsicle());
		this.use(Imagemin.jpegtran());
=======
	var self = this;
	cb = cb || function () {};

	if (!this.streams.length) {
		this.use(Imagemin.gifsicle());
		this.use(Imagemin.jpegtran());
		this.use(Imagemin.pngquant());
>>>>>>> f8417fafd5bf20d329bf2e3402fca16fd839cf1f
		this.use(Imagemin.optipng());
		this.use(Imagemin.svgo());
	}

<<<<<<< HEAD
	if (this.dest()) {
		this.streams.push(vinylFs.dest(this.dest()));
	}

	return streamCombiner(this.streams);
};

/**
 * Get files
 *
 * @api private
 */

Imagemin.prototype.getFiles = function () {
	if (Buffer.isBuffer(this.src())) {
		return bufferToVinyl.stream(this.src());
	}

	return vinylFs.src(this.src());
=======
	this.streams.unshift(this.read(this.src()));

	if (this.dest()) {
		this.streams.push(fs.dest(this.dest()));
	}

	var pipe = combine(this.streams);
	var end = concat(function (files) {
		cb(null, files, pipe);
	});

	pipe.on('data', this.emit.bind(this, 'data'));
	pipe.on('end', this.emit.bind(this, 'end'));
	pipe.on('error', cb);
	pipe.pipe(end);
};

/**
 * Read the source file
 *
 * @param {Array|Buffer|String} src
 * @api private
 */

Imagemin.prototype.read = function (src) {
	if (Buffer.isBuffer(src)) {
		var stream = through.obj();

		stream.end(new File({
			contents: src
		}));

		return stream;
	}

	return fs.src(src);
>>>>>>> f8417fafd5bf20d329bf2e3402fca16fd839cf1f
};

/**
 * Module exports
 */

module.exports = Imagemin;

[
	'gifsicle',
	'jpegtran',
	'optipng',
<<<<<<< HEAD
	'svgo'
].forEach(function (plugin) {
	module.exports[plugin] = optional('imagemin-' + plugin) || function () {
		return through.ctor({objectMode: true});
=======
	'pngquant',
	'svgo'
].forEach(function (plugin) {
	module.exports[plugin] = optional('imagemin-' + plugin) || function () {
		return through.ctor({ objectMode: true });
>>>>>>> f8417fafd5bf20d329bf2e3402fca16fd839cf1f
	};
});
